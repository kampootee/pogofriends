<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Friend Code Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        body { font-family: 'Inter', sans-serif; }
        /* Hide number input spinners */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type='number'] { -moz-appearance: textfield; }
        
        /* Transition for list items */
        .list-item { transition: all 0.3s ease-in-out; }
    </style>
    <script type="module" defer>
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- THIS IS THE CORRECTED LINE ---
        // 'setLogLevel' is now combined with the other firestore imports
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, serverTimestamp, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // ----------------------------------

        // --- 3. Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyAYay2cu9x-kCx37SLsHWfwhOikgHZOfqM",
          authDomain: "pogofriends-a018d.firebaseapp.com",
          projectId: "pogofriends-a018d",
          storageBucket: "pogofriends-a018d.firebasestorage.app",
          messagingSenderId: "746239293067",
          appId: "1:746239293067:web:c560238a7df9b75f47068e",
          measurementId: "G-XV6CNNHXK6"
        };
        
        // --- FIX: Define appId for use in database paths ---
        const appId = firebaseConfig.appId;

        // Initialize Firebase
        let app, db, auth;
        let userId = null;
        let friendsList = []; // Local cache for the list
        let currentSearchTerm = ''; // For filtering

        // --- 4. Element References ---
        const listContainer = document.getElementById('friend-list-container');
        const form = document.getElementById('friend-input-form');
        const usernameInput = document.getElementById('username');
        const codeInput = document.getElementById('friend-code');
        const colorInput = document.getElementById('list-color');
        const submitButton = document.getElementById('submit-button');
        const messageArea = document.getElementById('message-area');
        const searchInput = document.getElementById('search-input');
        const loadingSpinner = document.getElementById('loading-spinner');
        const listWrapper = document.getElementById('list-wrapper');

        // --- 5. Initialization ---
        function initializeAppCore() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // setLogLevel('Debug'); // Enable Firestore logging

                // Set auth persistence
                setPersistence(auth, browserLocalPersistence)
                    .then(() => {
                        console.log("Persistence set to local.");
                        setupAuthListener();
                    })
                    .catch((error) => {
                        console.error("Error setting persistence: ", error);
                        setupAuthListener(); // Continue anyway
                    });

            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                showMessage("Error connecting to the service. Please refresh.", "error");
                loadingSpinner.classList.add('hidden');
            }
        }

        // --- 6. Authentication ---
        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("User is signed in:", user.uid);
                    userId = user.uid;
                    // User is authenticated, now we can set up the real-time listener
                    setupRealTimeListener();
                } else {
                    console.log("User is not signed in. Authenticating...");
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            console.log("Signing in with custom token...");
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            console.log("Signing in anonymously...");
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication Error:", error);
                        showMessage("Could not authenticate. Please refresh.", "error");
                        loadingSpinner.classList.add('hidden');
                    }
                }
            });
        }

        // --- 7. Real-Time Data Listener ---
        function setupRealTimeListener() {
            if (!userId) {
                console.error("Listener setup failed: userId is null.");
                // This function will be re-called by onAuthStateChanged when userId is set
                return;
            }

            console.log("Setting up real-time listener...");
            // Path for public data
            const collectionPath = `artifacts/${appId}/public/data/friend-codes`;
            const q = query(collection(db, collectionPath));

            try {
                onSnapshot(q, (snapshot) => {
                    console.log("Received snapshot update. Documents count:", snapshot.size);
                    friendsList = []; // Clear local cache
                    snapshot.forEach((doc) => {
                        friendsList.push({ id: doc.id, ...doc.data() });
                    });

                    // Sort by timestamp (newest first)
                    friendsList.sort((a, b) => {
                        const timeA = a.createdAt?.seconds || 0;
                        const timeB = b.createdAt?.seconds || 0;
                        return timeB - timeA; // Descending order
                    });

                    console.log("Local list updated:", friendsList);
                    updateHtmlList(); // Re-render the list
                    
                    // Hide spinner and show list
                    loadingSpinner.classList.add('hidden');
                    listWrapper.classList.remove('hidden');

                }, (error) => {
                    console.error("Snapshot Error:", error);
                    showMessage("Error fetching live data. Check console.", "error");
                    loadingSpinner.classList.add('hidden');
                });
            } catch (e) {
                console.error("Error setting up listener:", e);
                showMessage("Critical error starting real-time service.", "error");
            }
        }

        // --- 8. UI Rendering Function ---
        function updateHtmlList() {
            if (!listContainer) return;
            listContainer.innerHTML = ''; // Clear current list

            const colorMap = {
                'red': 'bg-red-100 border-l-4 border-red-500',
                'blue': 'bg-blue-100 border-l-4 border-blue-500',
                'yellow': 'bg-yellow-100 border-l-4 border-yellow-500',
            };
            
            // --- FILTER LOGIC ---
            let filteredList = friendsList;
            if (currentSearchTerm) {
                filteredList = friendsList.filter(friend => 
                    friend.name.toLowerCase().includes(currentSearchTerm)
                );
            }
            // ---
